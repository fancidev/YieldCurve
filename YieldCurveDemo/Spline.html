<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="utf-8" />
  <title>Hello</title>
  <script type="text/javascript" src="file:///e:/Dev/Repos/YieldCurve/YieldCurveDemo/jquery-1.11.3.min.js"></script>
  <script type="text/javascript" src="file:///e:/Dev/Repos/YieldCurve/YieldCurveDemo/canvasjs-1.8.0-beta4-mod.js"></script>
  <script type="text/javascript" src="file:///e:/Dev/Repos/YieldCurve/YieldCurveDemo/jquery.canvasjs.js"></script>
  <script type="text/javascript" src="file:///e:/Dev/Repos/YieldCurve/YieldCurveDemo/numeric-1.2.6.js"></script>

  <script type="text/javascript" src="file:///e:/Dev/Repos/YieldCurve/YieldCurveDemo/jqwidgets/jqxcore.js"></script>
  <script type="text/javascript" src="file:///e:/Dev/Repos/YieldCurve/YieldCurveDemo/jqwidgets/jqxbuttons.js"></script>
  <script type="text/javascript" src="file:///e:/Dev/Repos/YieldCurve/YieldCurveDemo/jqwidgets/jqxscrollbar.js"></script>
  <script type="text/javascript" src="file:///e:/Dev/Repos/YieldCurve/YieldCurveDemo/jqwidgets/jqxlistbox.js"></script>
  <script type="text/javascript" src="file:///e:/Dev/Repos/YieldCurve/YieldCurveDemo/jqwidgets/jqxdropdownlist.js"></script>
  <link rel="stylesheet" href="file:///e:/Dev/Repos/YieldCurve/YieldCurveDemo/jqwidgets/styles/jqx.base.css" type="text/css" />
  
  <!--<script type="text/javascript" src="file:///e:/Dev/Repos/YieldCurve/YieldCurveDemo/bspline.js"></script>-->
  <!--<script type="text/javascript" src="file:///e:/Dev/Repos/YieldCurve/YieldCurveDemo/instrument.js"></script>-->
  <script type="text/javascript" src="Scripts/BSpline.js"></script>
  <script type="text/javascript" src="Scripts/YieldCurveBuilder.js"></script>
  <script type="text/javascript" src="Scripts/Instruments.js"></script>
  
  <script type="text/javascript">
$(function () {
	
	$("#termStructureChart").CanvasJSChart({
		title: {
			text: 'US Swap Rate Term Structure',
			fontSize: 16
		},
		legend: { 
			fontSize: 12,
		},
		axisX: {
			labelFontSize: 12,
			minimum: 0,
			gridThickness: 1,
			gridColor: 'gray',
			gridDashType: 'dash'
		},
		axisY: {
			labelFontSize: 12,
			gridThickness: 1,
			gridColor: 'gray',
			gridDashType: 'dash',
			labelFormatter: function (e) { return CanvasJS.formatNumber(e.value, '0.00'); }
		},
		toolTip: {
			shared: true
		},
		data: [ ]
	});
	
	$("#bumpResponseChart").CanvasJSChart({
		title: {
			text: 'Bump Response',
			fontSize: 16
		},
		legend: {
			fontSize: 12,
		},
		axisX: {
			labelFontSize: 12,
			minimum: 0,
			gridThickness: 1,
			gridColor: 'gray',
			gridDashType: 'dash'
		},
		axisY: {
			labelFontSize: 12,
			gridThickness: 1,
			gridColor: 'gray',
			gridDashType: 'dash',
			interval: 1.0,
			//labelFormatter: function (e) { return CanvasJS.formatNumber(e.value, '0.00'); }
		},
		toolTip: {
			shared: false
		},
		data: [ ]
	});
});

  </script>
  <script type="text/javascript">

	window.onerror = function () { return true; };

	$(document).ready(function () {
		var defaultPresetIndex = 2;
		
		$("#presetList").jqxDropDownList({
			source: splinePresets.map(function(p){return p.name+' Spline';}), 
			selectedIndex: defaultPresetIndex, 
			width: 150, 
			height: 20,
			autoDropDownHeight: true,
			animationType: 'none',
		});
		$("#presetList").on('select', function (e) {
			if (e && e.args) {
				var index = e.args.index;
				drawYieldCurve(splinePresets[index]);
				//drawTermStructure(splinePresets[index]);
				drawBumpResponse(splinePresets[index]);
				//drawBezierBasis(splinePresets[index]);
			}
		});

		//drawYieldCurve(splinePresets[defaultPresetIndex]);
		//drawTermStructure(splinePresets[defaultPresetIndex]);
		//drawBumpResponse(splinePresets[defaultPresetIndex]);
		drawBezierBasis(splinePresets[defaultPresetIndex]);
	});
	
	// Plot each row in the table as a series.
	function drawBezierBasis(preset) 
	{
		var chart = $("#bumpResponseChart").CanvasJSChart();
		chart.options.data.length = 0; // clear existing series

		var x = defaultDataPoints.map(function(p){return p.x;});
		var xMin = x[0];
		var xMax = x[x.length-1];
		var spline = new BSpline(x, preset.degree, preset.conditions);

		var n = x.length;
		var p = preset.degree;
		
		for (var i = 0; i < n + p - 1; i++)
		{
			var g = spline.basis(i,0);
			var dataPoints = [];
			var xx = [];
			var yy = [];
			for (var t = xMin; t <= xMax; t+=1/32) {
				dataPoints.push({ x: t, y: g(t) });
			}
			chart.options.data.push({
				type: 'line',
				name: 'Basis_' + i,
				markerType: 'square',
				showInLegend: true,
				dataPoints: dataPoints
			});
		}
		chart.options.toolTip.shared = true;
		chart.render();
	}
	
	var splinePresets = [
	{
		name: 'Linear',
		degree: 1,
		conditions: []
	},
	{
		name: 'Quadratic',
		degree: 2,
		conditions: [ 
			{ knotIndex: -1, derivOrder: 1, derivValue: 0 },
		]
	},
	{
		name: 'Cubic',
		degree: 3,
		conditions: [
			{ knotIndex:  0, derivOrder: 2, derivValue: 0 },
			{ knotIndex: -1, derivOrder: 2, derivValue: 0 },
		]
	},
	{
		name: 'Quartic',
		degree: 4,
		conditions: [
			{ knotIndex:  0, derivOrder: 2, derivValue: 0 },
			{ knotIndex: -1, derivOrder: 3, derivValue: 0 },
			{ knotIndex: -1, derivOrder: 2, derivValue: 0 },
		]
	},
	{
		name: 'Quintic',
		degree: 5,
		conditions: [
			{ knotIndex:  0, derivOrder: 2, derivValue: 0 },
			{ knotIndex: -1, derivOrder: 4, derivValue: 0 },
			{ knotIndex: -1, derivOrder: 3, derivValue: 0 },
			{ knotIndex: -1, derivOrder: 2, derivValue: 0 },			
		]
	}];
	
	var defaultDataPoints = [
		{ x: 0.25, y: 5.39 },
		{ x: 1, y: 5.39 },
		{ x: 2, y: 5.21 },
		{ x: 3, y: 5.16 },
		{ x: 4, y: 5.16 },
		{ x: 5, y: 5.18 },
		{ x: 7, y: 5.23 },
		{ x: 10, y: 5.29 },
		{ x: 30, y: 5.41 }
	];
		
	// Plot each row in the table as a series.
	function drawTermStructure(preset) 
	{
		var dataPoints = defaultDataPoints;
		
		var chart = $("#termStructureChart").CanvasJSChart();
		chart.options.data.length = 0; // clear existing series
		
		// Plot input data points.
		if (true) {
			chart.options.data.push({
				type: 'scatter',
				name: 'Term structure',
				markerType: 'square',
				showInLegend: true,
				dataPoints: dataPoints
			});
		}
		
		// Plot interpolated curve.
		if (true) {
			var XY = bsplineInterp(dataPoints, preset.degree, preset.conditions);
			chart.options.data.push({
				type: 'line',
				name: preset.name + ' Spline',
				markerType: 'none',
				showInLegend: true,
				dataPoints: XY
			});
		}
		
		adjustYAxisLimits(chart);
		chart.render();
	}
	
	function drawBumpResponse(preset)
	{
		var dataPoints = defaultDataPoints;		
		var chart = $("#bumpResponseChart").CanvasJSChart();
		chart.options.data.length = 0;
		var XY = bsplineInterp(dataPoints, preset.degree, preset.conditions);
		
		// bump each point
		for (var i = 0; i < dataPoints.length; i++) {
			var bumpedDataPoints = dataPoints.slice();
			bumpedDataPoints[i] = {
				x: bumpedDataPoints[i].x,
				y: bumpedDataPoints[i].y + 0.01
			};
			var bumpedXY = bsplineInterp(bumpedDataPoints, preset.degree, preset.conditions);
			var diff = [];
			for (var j = 0; j < XY.length; j++) {
				diff[j] = {
					x: XY[j].x,
					y: (bumpedXY[j].y - XY[j].y) * 100
				};
			}
			chart.options.data.push({
				type: 'line',
				name: dataPoints[i].x + 'Y',
				markerType: 'none',
				showInLegend: true,
				dataPoints: diff
			});
		}
		//adjustYAxisLimits(chart);
		chart.render();
	}
	
	function drawYieldCurve(preset) 
	{
		var dataPoints = defaultDataPoints;
		var n = dataPoints.length;
		var Instrument = Swap; // Fra;
		var instruments = [];
		var marketRates = [];
		for (var i = 0; i < n; i++) {
			instruments[i] = new Instrument(dataPoints[i].x);
			marketRates[i] = dataPoints[i].y / 100;
		}

		// Build the yield curve.
		var discount = buildYieldCurve(instruments, marketRates, preset);
		
		// Plot it...
		var chart = $("#termStructureChart").CanvasJSChart();
		chart.options.data.length = 0; // clear existing series
		
		// Plot input data points.
		if (true) {
			chart.options.data.push({
				type: 'scatter',
				name: 'Term structure',
				markerType: 'square',
				showInLegend: true,
				dataPoints: dataPoints
			});
		}
		
		// Plot interpolated curve.
		var PlotInstrument = Swap; // InstFwd; // LogDf; // Swap; // LogDf;
		var interpolatedPoints = [];
		for (var t = dataPoints[0].x; t <= dataPoints[n-1].x; t += 1/16) {
			var instrument = new PlotInstrument(t);
			var impliedRate = instrument.impliedRate(discount);
			interpolatedPoints.push({x: t, y: impliedRate*100});
			//var XY = bsplineInterp(dataPoints, preset.degree, preset.conditions);
		}
		chart.options.data.push({
			type: 'line',
			name: '(' + preset.name + ' Spline)',
			markerType: 'none',
			showInLegend: true,
			dataPoints: interpolatedPoints
		});
		//alert('Plotted');
		
		adjustYAxisLimits(chart);
		chart.render();
	}
	
	function adjustYAxisLimits(chart)
	{
		var minY = Infinity;
		var maxY = -Infinity;
		var data = chart.options.data;
		for (var i = 0; i < data.length; i++) {
			var dataPoints = data[i].dataPoints;
			for (var j = 0; j < dataPoints.length; j++) {
				var value = dataPoints[j].y;
				minY = Math.min(minY, value);
				maxY = Math.max(maxY, value);
			}
		}
		
		// Adjust the Y-axis range to half-percent with 5bp margin.
		var margin = 0.05;
		var roundTo = 0.50;
		minY = Math.floor((minY - margin) / roundTo) * roundTo;
		maxY = Math.ceil((maxY + margin) / roundTo) * roundTo;
		chart.options.axisY.minimum = minY;
		chart.options.axisY.maximum = maxY;
		
		// Note: the caller must call chart.render() to take effect.
		// chart.render();
	}
	
	function bsplineInterp(points, degree, conditions)
	{
		var x = points.map(function(pt){return pt.x});
		var spline = new BSpline(x, degree, conditions);
		
		var y = points.map(function(pt){return pt.y});
		var yy = y.concat(conditions.map(function(c){return c.derivValue;}));
		var f = spline.fit(yy);
		
		var xMin = x[0];
		var xMax = x[x.length-1];
		var gridX = numeric.linspace(xMin, xMax, 200);
		var gridXY = [];
		for (var i = 0; i < gridX.length; i++) {
			var x = gridX[i];
			var y = f(x);
			gridXY.push({x: x, y: y});
		}
		return gridXY;
	}

	function zeroVector(length)
	{
		var v = [];
		for (var i = 0; i < length; i++) {
			v.push(0);
		}
		return v;
	}
	
	// Bezier basis function: N[i,n,a](u)
	// See the book
	function N(i, n, a, u)
	{
		if (n == 0) {
			//var leftContinuous = false;
			//if (leftContinuous)
			//	return (u > a[i] && u <= a[i+1])? 1 : 0;
			//else
			//	return (u >= a[i] && u < a[i+1])? 1 : 0;
			if (u >= a[i] && u < a[i+1])
				return 1;
			if (u == a[i+1] && a[i] < a[i+1] && a[i+1] == a[a.length-1])
				return 1;
			return 0;
		}
		var alpha1 = (a[i+n]-a[i]==0)? 0 : (u-a[i])/(a[i+n]-a[i]);
		var alpha2 = (a[i+1+n]-a[i+1]==0)? 0 : (u-a[i+1])/(a[i+1+n]-a[i+1]);
		return alpha1*N(i,n-1,a,u)+(1-alpha2)*N(i+1,n-1,a,u);
	}
	
	// Derivative of B-spline basis Bezier basis function: N[i,n,a](u)
	// See the book
	function dN(i, n, a, u, d)
	{
		if (d == 0) {
			return N(i, n, a, u);
		}
		if (n == 0) {
			return NaN;
		}
		var v1 = (a[i+n] - a[i] == 0)? 1 : (a[i+n] - a[i]);
		var v2 = (a[i+n+1] - a[i+1] == 0)? 1 : (a[i+n+1] - a[i+1]);
		return n/v1*dN(i,n-1,a,u,d-1)-n/v2*dN(i+1,n-1,a,u,d-1);
	}
	
  </script>
</head>

<body>
  <div>
    <div id="toolBar" style="margin-bottom: 5px; padding:5px; border-width:1px; border-color:black; border-style:solid">
      <div style="float: left">Date:&nbsp;</div>
      <div style="float: left" id="dateList">[Date List]</div>
      <div style="float: left">&nbsp;Interpolation:&nbsp;</div>
      <div style="float: left" id="presetList">[Preset List]</div>
      <div style="float: left">&nbsp;Curve:&nbsp;</div>
      <div style="float: left" id="curveTypeList">[Curve Type List]</div>
      <div>&nbsp;</div>
    </div>
    <div id="termStructureChart" style="width:100%; height:300px; border-width:1px; border-style:solid; border-color:black">
      [Term Structure]
    </div>
    <div id="bumpResponseChart" style="margin-top: 5px; width:100%; height:250px; border-width:1px; border-style:solid; border-color:black">
      [Bump Response]
    </div>
    <div id="debugOutput">[Debug]</div>
  </div>
</body>
</html>
